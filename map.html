<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>地图可视化</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/earth.css">
    <link rel="stylesheet" href="css/d3-tip.css">
    <script src="d3/d3.min.js"></script>
    <script src="d3/topojson.min.js"></script>
    <script src="d3/d3-v6-tip.js"></script>
    <script src="d3/d3-geo-projection.min.js"></script>
</head>

<body>
    <input type="checkbox" id="menu_btn">
    <label class="menu-btn" for="menu_btn">
        <i class="fa fa-bars" aria-hidden="true"></i>
    </label>
    <svg width="1600" height="1000" id="mainsvg" class="svgs" style='display: block; margin: 0 auto;'></svg>
    <script>

        let svg = d3.select('svg');
        const width = +svg.attr('width');
        const height = +svg.attr('height');
        const margin = { top: 0, right: 0, bottom: 0, left: 0 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;
        const g = svg.append('g').attr('id', 'maingroup')
            .attr('transform', `translate(${margin.left}, ${margin.top})`);

        const projection = d3.geoEquirectangular(); // Plate Carrée投影（等距）
        const pathGenerator = d3.geoPath().projection(projection);

        // setting up the tip tool; 
        const tip = d3.tip()
            .attr('class', 'd3-tip').html(function (event, d) { return d.properties.name });
        svg.call(tip);

        let worldmeta;
        let lastid = undefined;

        d3.json('data/countries-110m.json').then(
            function (data) {
                // convert topo-json to geo-json; 
                worldmeta = topojson.feature(data, data.objects.countries);

                // this code is really important if you want to fit your geoPaths (map) in your SVG element; 
                projection.fitSize([innerWidth, innerHeight], worldmeta);

                // perform data-join; 
                const paths = g.selectAll('path')
                    .data(worldmeta.features, d => d.properties.name)
                    .enter().append('path')
                    .attr('d', pathGenerator)
                    .attr('stroke', 'black')
                    .attr('stroke-width', 1)
                    .on('mouseover', function (d) {
                        d3.select(this)
                            .attr("opacity", 0.5)
                            .attr("stroke", "white")
                            .attr("stroke-width", 6);
                    })
                    .on('mouseout', function (d) {
                        d3.select(this)
                            .attr("opacity", 1)
                            .attr("stroke", "black")
                            .attr("stroke-width", 1);
                    })
                    .on('contextmenu', function (event, d) {
                        event.preventDefault();
                        if (lastid !== d.properties.name) {
                            tip.show(event, d)
                            lastid = d.properties.name;
                        } else {
                            tip.hide(event, d)
                        }
                    })
            }
        );

    </script>
    <div class="wrapper">
        <ul class="menu">
            <li><a href="main.html">首页</a></li>
            <li><a href="intro.html">背景介绍</a></li>
            <li><a href="map.html">地图可视化</a></li>
            <li><a href="#">词云</a></li>
            <li><a href="chart.html">统计图表</a></li>
        </ul>
    </div>
</body>

</html>